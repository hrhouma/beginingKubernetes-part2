### Étape 1 : Clonage du dépôt GitHub

Tout d'abord, nous allons cloner le dépôt GitHub qui contient les fichiers nécessaires.

```bash
cd Desktop
git clone https://github.com/alihussainia/Monitoring-Kubernetes-Cluster.git
cd Monitoring-Kubernetes-Cluster
```

### Étape 2 : Création du cluster Kubernetes

Nous allons utiliser Kind (Kubernetes IN Docker) pour créer un cluster Kubernetes.

```bash
kind create cluster
```

### Étape 3 : Vérification du cluster

Vérifiez que le cluster a été correctement créé.

```bash
kind get clusters
kubectl cluster-info --context kind-kind
kubectl get nodes
kubectl get all -A
```

### Étape 4 : Déploiement de l'application avec les fichiers YAML

#### `deployment.yml`

Contenu du fichier `deployment.yml` :

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-app
  labels:
    app: nginx-app
spec:
  replicas: 4
  selector:
    matchLabels:
      app: nginx-app
  template:
    metadata:
      labels:
        app: nginx-app
    spec:
      containers:
      - name: nginx-app
        image: nginx:1.16.1-alpine
        ports:
        - containerPort: 80
```

Appliquer le déploiement :

```bash
kubectl apply -f deployment.yml
kubectl get deploy
kubectl get pods
```

#### `service.yml`

Contenu du fichier `service.yml` :

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  selector:
    app: nginx-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
  type: ClusterIP
```

Appliquer le service :

```bash
kubectl apply -f service.yml
kubectl get svc
```

### Étape 5 : Création d'un utilisateur administrateur pour le dashboard

#### `dashboard-adminuser.yml`

Contenu du fichier `dashboard-adminuser.yml` :

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kube-system
```

Appliquer le fichier :

```bash
kubectl apply -f dashboard-adminuser.yml
```

### Étape 6 : Déploiement et accès au dashboard Kubernetes

1. Obtenez le token d'accès :

```bash
kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}')
```

2. Lancez le proxy Kubernetes :

```bash
kubectl proxy
```

3. Accédez au dashboard à partir de votre navigateur en utilisant l'URL suivante :

```
http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/
```

### Étape 7 : Déploiement de Prometheus

#### `prometheus.deployment.yml`

Contenu du fichier `prometheus.deployment.yml` :

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
      - name: prometheus
        image: prom/prometheus
        ports:
        - containerPort: 9090
```

Appliquer le fichier :

```bash
kubectl apply -f prometheus.deployment.yml
kubectl get deploy
kubectl get pods
```

### Étape 8 : Configuration de Grafana

#### `grafana.deployment.yml`

Créez un fichier `grafana.deployment.yml` avec le contenu suivant :

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
      - name: grafana
        image: grafana/grafana
        ports:
        - containerPort: 3000
```

Appliquer le fichier :

```bash
kubectl apply -f grafana.deployment.yml
kubectl get deploy
kubectl get pods
```

### Étape 9 : Exposition des services Prometheus et Grafana

Créez un fichier `prometheus-service.yml` pour exposer Prometheus :

```yaml
apiVersion: v1
kind: Service
metadata:
  name: prometheus
spec:
  type: NodePort
  selector:
    app: prometheus
  ports:
    - protocol: TCP
      port: 9090
      nodePort: 30000
```

Appliquer le fichier :

```bash
kubectl apply -f prometheus-service.yml
kubectl get svc
```

Créez un fichier `grafana-service.yml` pour exposer Grafana :

```yaml
apiVersion: v1
kind: Service
metadata:
  name: grafana
spec:
  type: NodePort
  selector:
    app: grafana
  ports:
    - protocol: TCP
      port: 3000
      nodePort: 30001
```

Appliquer le fichier :

```bash
kubectl apply -f grafana-service.yml
kubectl get svc
```

### Étape 10 : Accès à Grafana

Accédez à Grafana via votre navigateur en utilisant l'URL suivante :

```
http://localhost:30001
```

Les identifiants par défaut sont :
- Username: admin
- Password: admin

### Étape 11 : Configuration de Prometheus comme source de données dans Grafana

1. Connectez-vous à Grafana.
2. Allez dans **Configuration** -> **Data Sources**.
3. Cliquez sur **Add data source**.
4. Sélectionnez **Prometheus**.
5. Configurez l'URL comme suit :

```
http://prometheus:9090
```

6. Cliquez sur **Save & Test**.

### Conclusion

En suivant ces étapes, vous avez créé un cluster Kubernetes, déployé des applications, configuré le dashboard Kubernetes, déployé Prometheus et Grafana, et configuré Grafana pour utiliser Prometheus comme source de données. Vous pouvez maintenant utiliser Grafana pour visualiser les métriques de votre cluster Kubernetes.
